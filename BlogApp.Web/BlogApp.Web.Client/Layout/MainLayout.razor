@using System.Threading.Tasks
@inherits LayoutComponentBase
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime

<MudThemeProvider @bind-IsDarkMode="_isDarkMode" Theme="_theme" />
<MudDialogProvider />
<MudSnackbarProvider />
<MudPopoverProvider />

<MudLayout>
    <MudAppBar Elevation="1">
        <MudText>
            <MudLink Href="/" Underline="Underline.None" Typo="Typo.h5" Color="Color.Inherit">
                BlogApp
            </MudLink>
        </MudText>

        <MudButton Href="/posts" Color="Color.Inherit" Class="ml-5">Gönderiler</MudButton>

        <MudSpacer />

        <MudIconButton Icon="@(_isDarkMode? @Icons.Material.Filled.WbSunny : @Icons.Material.Filled.NightsStay)"
            Color="Color.Inherit" OnClick="ToggleDarkMode" />

        <AuthorizeView>
            <Authorized>
                <MudButton Href="/posts/create" Variant="Variant.Outlined" Color="Color.Inherit" Class="mr-2">
                    Gönderi Oluştur
                </MudButton>

                <MudMenu Icon="@Icons.Material.Filled.Person" Color="Color.Inherit" Edge="Edge.End">
                    <MudMenuItem>Hoşgeldin, @context.User.Identity?.Name</MudMenuItem>
                    <MudDivider />
                    <MudMenuItem Href="/profile">Profilim</MudMenuItem>
                    <MudMenuItem OnClick="Logout">Çıkış Yap</MudMenuItem>
                </MudMenu>
            </Authorized>

            <NotAuthorized>
                <MudButton Href="/login" Color="Color.Inherit">Giriş Yap</MudButton>
                <MudButton Href="/register" Variant="Variant.Outlined" Color="Color.Inherit" Class="ml-2">Kayıt Ol
                </MudButton>
            </NotAuthorized>
        </AuthorizeView>
    </MudAppBar>

    <MudMainContent>
        <MudContainer MaxWidth="MaxWidth.Large" Class="my-8 pt-8">
            @Body
        </MudContainer>
    </MudMainContent>
</MudLayout>

@code {
    private MudTheme _theme = new();
    private bool _isDarkMode;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var isDarkModeString = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "isDarkMode");
            if (bool.TryParse(isDarkModeString, out var isDarkMode))
            {
                _isDarkMode = isDarkMode;
                StateHasChanged();
            }
        }
        await base.OnAfterRenderAsync(firstRender);
    }

    private async Task ToggleDarkMode()
    {
        _isDarkMode = !_isDarkMode;
        await JSRuntime.InvokeVoidAsync("localStorage.setItem", "isDarkMode", _isDarkMode.ToString().ToLower());
    }

    private async Task Logout()
    {
        var jwtAuthProvider = (JwtAuthenticationStateProvider)AuthStateProvider;
        await jwtAuthProvider.MarkUserAsLoggedOut();
        NavigationManager.NavigateTo("/login");
    }
}